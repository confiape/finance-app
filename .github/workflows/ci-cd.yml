name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  DOCKER_IMAGE: confiape/finance

jobs:
  # Build Docker images
  docker-build:
    runs-on: ubuntu-latest
    outputs:
      backend_tag: ${{ steps.tags.outputs.backend_tag }}
      frontend_tag: ${{ steps.tags.outputs.frontend_tag }}
    steps:
      - uses: actions/checkout@v4
      - name: Generate tags
        id: tags
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "backend_tag=backend-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "frontend_tag=frontend-${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # PRs: solo build (valida que compile)
      # Push a main: build + push
      - name: Build Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ steps.tags.outputs.backend_tag }}
            ${{ env.DOCKER_IMAGE }}:backend-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ steps.tags.outputs.frontend_tag }}
            ${{ env.DOCKER_IMAGE }}:frontend-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Update CD repository (only on main)
  update-cd-repo:
    needs: docker-build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout CD repository
        uses: actions/checkout@v4
        with:
          repository: confiape/loan-cd
          token: ${{ secrets.CD_REPO_TOKEN }}
          path: loan-cd

      - name: Update values.finance.yaml
        run: |
          cd loan-cd
          sed -i 's/tag: "backend-[^"]*"/tag: "${{ needs.docker-build.outputs.backend_tag }}"/' values.finance.yaml
          sed -i 's/tag: "frontend-[^"]*"/tag: "${{ needs.docker-build.outputs.frontend_tag }}"/' values.finance.yaml
          cat values.finance.yaml

      - name: Commit and push changes
        run: |
          cd loan-cd
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add values.finance.yaml
          git commit -m "chore: update finance-app to ${{ needs.docker-build.outputs.backend_tag }} / ${{ needs.docker-build.outputs.frontend_tag }}"
          git push
